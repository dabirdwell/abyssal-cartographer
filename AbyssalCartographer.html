<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Abyssal Cartographer v1.1 - D&D Dungeon Generator</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; font-family: 'IBM Plex Sans', system-ui, -apple-system, sans-serif; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .pulse { animation: pulse 2s ease-in-out infinite; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useEffect, useMemo } = React;

    // Icon component
    const Icon = ({ name, size = 16, color = "currentColor", className = "" }) => {
      const ref = React.useRef(null);
      useEffect(() => {
        if (ref.current && lucide[name]) {
          ref.current.innerHTML = '';
          const svg = lucide.createElement(lucide[name]);
          svg.setAttribute('width', size);
          svg.setAttribute('height', size);
          svg.setAttribute('color', color);
          ref.current.appendChild(svg);
        }
      }, [name, size, color]);
      return <span ref={ref} className={`inline-flex items-center justify-center ${className}`} style={{width: size, height: size}} />;
    };

    // ===================== DATA =====================
    
    const MONSTERS = {
      kobold: { name: 'Kobold', cr: '1/8', ac: 12, hp: 5, str: 7, dex: 15, con: 9, int: 8, wis: 7, cha: 8, speed: 30, atk: [{ n: 'Dagger', h: 4, d: '1d4+2 piercing' }, { n: 'Sling', h: 4, d: '1d4+2 bludgeoning', r: '30/120' }], traits: ['Pack Tactics', 'Sunlight Sensitivity'], desc: 'Cowardly reptilians attacking in swarms' },
      giant_rat: { name: 'Giant Rat', cr: '1/8', ac: 12, hp: 7, str: 7, dex: 15, con: 11, int: 2, wis: 10, cha: 4, speed: 30, atk: [{ n: 'Bite', h: 4, d: '1d4+2 piercing' }], traits: ['Pack Tactics', 'Keen Smell'], desc: 'Disease-carrying vermin the size of dogs' },
      goblin: { name: 'Goblin', cr: '1/4', ac: 15, hp: 7, str: 8, dex: 14, con: 10, int: 10, wis: 8, cha: 8, speed: 30, atk: [{ n: 'Scimitar', h: 4, d: '1d6+2 slashing' }, { n: 'Shortbow', h: 4, d: '1d6+2 piercing', r: '80/320' }], traits: ['Nimble Escape'], desc: 'Cunning, cruel raiders' },
      skeleton: { name: 'Skeleton', cr: '1/4', ac: 13, hp: 13, str: 10, dex: 14, con: 15, int: 6, wis: 8, cha: 5, speed: 30, atk: [{ n: 'Shortsword', h: 4, d: '1d6+2 piercing' }, { n: 'Shortbow', h: 4, d: '1d6+2 piercing', r: '80/320' }], traits: ['Vulnerable: bludgeoning', 'Immune: poison'], desc: 'Animated bones bound by dark magic' },
      zombie: { name: 'Zombie', cr: '1/4', ac: 8, hp: 22, str: 13, dex: 6, con: 16, int: 3, wis: 6, cha: 5, speed: 20, atk: [{ n: 'Slam', h: 3, d: '1d6+1 bludgeoning' }], traits: ['Undead Fortitude'], desc: 'Shambling corpses' },
      orc: { name: 'Orc', cr: '1/2', ac: 13, hp: 15, str: 16, dex: 12, con: 16, int: 7, wis: 11, cha: 10, speed: 30, atk: [{ n: 'Greataxe', h: 5, d: '1d12+3 slashing' }, { n: 'Javelin', h: 5, d: '1d6+3 piercing', r: '30/120' }], traits: ['Aggressive'], desc: 'Brutal tribal warriors' },
      shadow: { name: 'Shadow', cr: '1/2', ac: 12, hp: 16, str: 6, dex: 14, con: 13, int: 6, wis: 10, cha: 8, speed: 40, atk: [{ n: 'Strength Drain', h: 4, d: '2d6+2 necrotic', s: 'STR reduced by 1d4' }], traits: ['Amorphous', 'Shadow Stealth'], desc: 'Living darkness' },
      hobgoblin: { name: 'Hobgoblin', cr: '1/2', ac: 18, hp: 11, str: 13, dex: 12, con: 12, int: 10, wis: 10, cha: 9, speed: 30, atk: [{ n: 'Longsword', h: 3, d: '1d8+1 slashing' }, { n: 'Longbow', h: 3, d: '1d8+1 piercing', r: '150/600' }], traits: ['Martial Advantage (+2d6)'], desc: 'Disciplined soldiers' },
      ghoul: { name: 'Ghoul', cr: '1', ac: 12, hp: 22, str: 13, dex: 15, con: 10, int: 7, wis: 10, cha: 6, speed: 30, atk: [{ n: 'Bite', h: 2, d: '2d6+2 piercing' }, { n: 'Claws', h: 4, d: '2d4+2 slashing', s: 'DC 10 CON or paralyzed' }], traits: ['Immune: poison'], desc: 'Paralyzing undead' },
      bugbear: { name: 'Bugbear', cr: '1', ac: 16, hp: 27, str: 15, dex: 14, con: 13, int: 8, wis: 11, cha: 9, speed: 30, atk: [{ n: 'Morningstar', h: 4, d: '2d8+2 piercing' }], traits: ['Brute', 'Surprise Attack (+2d6)'], desc: 'Ambush predators' },
      specter: { name: 'Specter', cr: '1', ac: 12, hp: 22, str: 1, dex: 14, con: 11, int: 10, wis: 10, cha: 11, speed: '0, fly 50', atk: [{ n: 'Life Drain', h: 4, d: '3d6 necrotic', s: 'DC 10 or HP max reduced' }], traits: ['Incorporeal'], desc: 'Vengeful spirits' },
      dire_wolf: { name: 'Dire Wolf', cr: '1', ac: 14, hp: 37, str: 17, dex: 15, con: 15, int: 3, wis: 12, cha: 7, speed: 50, atk: [{ n: 'Bite', h: 5, d: '2d6+3 piercing', s: 'DC 13 STR or prone' }], traits: ['Pack Tactics'], desc: 'Massive pack hunters' },
      ogre: { name: 'Ogre', cr: '2', ac: 11, hp: 59, str: 19, dex: 8, con: 16, int: 5, wis: 7, cha: 7, speed: 40, atk: [{ n: 'Greatclub', h: 6, d: '2d8+4 bludgeoning' }], traits: [], desc: 'Dim-witted giants' },
      mimic: { name: 'Mimic', cr: '2', ac: 12, hp: 58, str: 17, dex: 12, con: 15, int: 5, wis: 13, cha: 8, speed: 15, atk: [{ n: 'Pseudopod', h: 5, d: '1d8+3', s: 'Grappled DC 13' }, { n: 'Bite', h: 5, d: '1d8+3 + 1d8 acid' }], traits: ['Shapechanger', 'Adhesive'], desc: 'Treasure chest predator' },
      ghast: { name: 'Ghast', cr: '2', ac: 13, hp: 36, str: 16, dex: 17, con: 10, int: 11, wis: 10, cha: 8, speed: 30, atk: [{ n: 'Claws', h: 5, d: '2d6+3 slashing', s: 'DC 10 or paralyzed' }], traits: ['Stench DC 10'], desc: 'Elite ghouls' },
      gargoyle: { name: 'Gargoyle', cr: '2', ac: 15, hp: 52, str: 15, dex: 11, con: 16, int: 6, wis: 11, cha: 7, speed: '30, fly 60', atk: [{ n: 'Bite', h: 4, d: '1d6+2' }, { n: 'Claws', h: 4, d: '1d6+2' }], traits: ['False Appearance', 'Resist nonmagical'], desc: 'Stone guardians' },
      wight: { name: 'Wight', cr: '3', ac: 14, hp: 45, str: 15, dex: 14, con: 16, int: 10, wis: 13, cha: 15, speed: 30, atk: [{ n: 'Life Drain', h: 4, d: '1d6+2 necrotic', s: 'DC 13 or HP max reduced' }, { n: 'Longsword', h: 4, d: '1d8+2' }], traits: ['Creates zombies'], desc: 'Undead commanders' },
      owlbear: { name: 'Owlbear', cr: '3', ac: 13, hp: 59, str: 20, dex: 12, con: 17, int: 3, wis: 12, cha: 7, speed: 40, atk: [{ n: 'Beak', h: 7, d: '1d10+5' }, { n: 'Claws', h: 7, d: '2d8+5' }], traits: ['Keen Sight/Smell', 'Multiattack'], desc: 'Ferocious hybrids' },
      flameskull: { name: 'Flameskull', cr: '4', ac: 13, hp: 40, str: 1, dex: 17, con: 14, int: 16, wis: 10, cha: 11, speed: '0, fly 40', atk: [{ n: 'Fire Ray', h: 5, d: '3d6 fire', r: '30' }], traits: ['Magic Resistance', 'Spells: fireball 1/day'], desc: 'Burning sentinels' },
      wraith: { name: 'Wraith', cr: '5', ac: 13, hp: 67, str: 6, dex: 16, con: 16, int: 12, wis: 14, cha: 15, speed: '0, fly 60', atk: [{ n: 'Life Drain', h: 6, d: '4d8+3 necrotic', s: 'DC 14 or HP max reduced' }], traits: ['Incorporeal', 'Create Specter'], desc: 'Malevolent spirits' },
    };

    const BOSSES = [
      { base: 'wraith', title: 'The Hollow King', mod: '90 HP, legendary resistance 1/day', lair: 'Commands 2 specters. Throne reveals vault.' },
      { base: 'wight', title: 'The Fallen Champion', mod: '65 HP, AC 18, +1 longsword', lair: '4 zombie honor guard. Magic weapon on corpse.' },
      { base: 'ogre', title: 'Garthok the Render', mod: '85 HP, Extra Attack, DC 12 fear', lair: 'Trophy alcoves with past victims\' gear.' },
      { base: 'ghast', title: 'The Hunger Priest', mod: '55 HP, Bane 2/day, 4 ghouls', lair: 'Destroy altar to weaken all undead.' },
      { base: 'flameskull', title: 'The Burning Oracle', mod: '55 HP, fireball 2/day', lair: 'Must answer riddle to destroy.' },
      { base: 'owlbear', title: 'Razorbeak Ancient', mod: '80 HP, +2 AC, multiattack', lair: 'Eggs worth 500gp.' },
      { base: 'gargoyle', title: 'The Stone Sentinel', mod: '70 HP, AC 17, Regen 5/round', lair: 'Destroy hidden gem to end regen.' },
    ];

    const TRAPS = [
      { name: 'Pit Trap', det: 12, dis: 10, trigger: 'Pressure plate', eff: '1d6 fall, DC 10 Athletics to climb out', desc: 'Concealed pit' },
      { name: 'Poison Darts', det: 15, dis: 13, trigger: 'Tripwire', eff: '1d4 + DC 13 CON or 2d6 poison', desc: 'Darts from wall' },
      { name: 'Swinging Blade', det: 14, dis: 15, trigger: 'Pressure plate', eff: '3d6 slash, DC 13 DEX half', desc: 'Pendulum blade' },
      { name: 'Fire Glyph', det: 15, dis: 15, trigger: 'Proximity 5ft', eff: '4d6 fire, DC 14 DEX half, 10ft radius', desc: 'Arcane runes' },
      { name: 'Sleep Gas', det: 14, dis: 12, trigger: 'Opening door/chest', eff: 'DC 13 CON or unconscious 1 min', desc: 'Sedative gas' },
      { name: 'Collapsing Ceiling', det: 16, dis: 14, trigger: 'Removing treasure', eff: '4d6 bludgeoning, may block exit', desc: 'Weakened supports' },
      { name: 'Spectral Chains', det: 14, dis: 15, trigger: 'Stepping on runes', eff: 'DC 14 WIS or restrained + 2d6/round', desc: 'Ghostly chains' },
      { name: 'Symbol of Pain', det: 16, dis: 16, trigger: 'Reading inscription', eff: 'DC 15 CON or incapacitated 1 min', desc: 'Magical suffering' },
    ];

    const TREASURE = {
      minor: ['2d6 gp', '1d4 gems (10gp)', 'Potion of Healing', 'Silvered dagger', 'Spell scroll (1st)', "Healer's kit"],
      moderate: ['4d6 gp', '2d4 gems (50gp)', 'Potion of Greater Healing', '+1 ammo (5)', 'Spell scroll (2nd)', 'Wand of Magic Detection'],
      major: ['8d6 gp + 2d6 pp', '+1 weapon', 'Cloak of Protection', 'Ring of Protection', 'Bag of Holding', 'Boots of Elvenkind'],
    };

    const FEATURES = [
      { name: 'Crumbling Pillars', effect: 'Half cover. DC 12 Athletics to topple (5ft, 2d6 bludgeoning).' },
      { name: 'Shallow Water', effect: 'Difficult terrain. Splashing alerts nearby.' },
      { name: 'Elevated Platform', effect: '10ft high. DC 12 Athletics to climb. +2 AC vs melee from below.' },
      { name: 'Hanging Chains', effect: 'Climbable. DC 10 DEX or prone on landing.' },
      { name: 'Unstable Floor', effect: 'Dashing requires DC 12 DEX or fall prone.' },
      { name: 'Magical Darkness', effect: 'Corners in darkness darkvision can\'t penetrate.' },
      { name: 'Braziers', effect: 'Dim light 20ft. DC 10 STR to tip, 1d6 fire in 5ft.' },
      { name: 'Thick Webs', effect: 'Difficult terrain. Flammable (2d4 fire to creatures inside).' },
      { name: 'Statues', effect: 'DC 14 Investigation: one is hollow (treasure or trap).' },
      { name: 'Fungal Growth', effect: 'Dim light. DC 12 Nature: edible (1 HP) or poison (1d4).' },
    ];

    const PUZZLES = [
      { name: 'The Three Statues', setup: 'Three statues face a locked door: Warrior (sword), Mage (staff), Rogue (daggers). Plaques: "Truth speaks first. Wisdom follows. Cunning acts last."', solution: 'Press plaques in order: Warrior, Mage, Rogue.', hint: 'The virtues match their classes.', trap: 'Wrong order: 2d6 fire (DC 13 DEX half).' },
      { name: 'The Weighted Scales', setup: 'Large scale with two platforms. "Balance life and death." Pile of skulls and golden apples nearby (5 lbs each).', solution: 'Equal weight of skulls and apples (3 each).', hint: 'True balance, not choosing one.', trap: 'Unbalanced: Floor tilts to pit (DC 14 DEX or 2d6 fall).' },
      { name: 'The Elemental Braziers', setup: 'Four unlit braziers. Central pedestal with red, blue, white, green stones. Murals show volcano, ocean, mountain, forest.', solution: 'Red‚Üívolcano, Blue‚Üíocean, White‚Üímountain, Green‚Üíforest.', hint: 'The murals are a map.', trap: 'Wrong: 3d6 elemental damage (DC 14 save).' },
      { name: 'The Blood Door', setup: 'Door with bowl. "Only the willing may pass. Give freely what you would protect."', solution: 'Willingly give blood (1 HP). Coerced blood fails.', hint: '"Willing" and "freely" are key. It costs less than you think.', trap: 'Forced blood: Door seals 24 hours.' },
      { name: 'The Musical Lock', setup: 'Door with carved birds on a staff (musical bars). Different heights. Nearby chimes.', solution: 'Play the notes the birds sit on. It\'s sheet music.', hint: 'Look WHERE the birds sit on the lines.', trap: 'Wrong notes: 2d8 thunder, DC 13 CON, pushed 10ft.' },
      { name: 'The Mirror Maze', setup: 'Room of mirrors. True exit only visible as reflection. "Trust not your eyes, but their echo."', solution: 'Walk backward toward reflected door, or navigate by touch.', hint: 'Echoes are reflections. What reflects sight?', trap: 'Wrong mirror: DC 12 WIS or frightened 1 min.' },
    ];

    const RIDDLES = [
      { q: "I have cities, but no houses. Mountains, but no trees. Water, but no fish. What am I?", a: "A map", hint: "Representations, not reality." },
      { q: "The more you take, the more you leave behind. What am I?", a: "Footsteps", hint: "Consider your journey here." },
      { q: "I speak without a mouth and hear without ears. I have no body, but come alive with wind. What am I?", a: "An echo", hint: "Your voice returns in these halls." },
      { q: "What can fill a room but takes up no space?", a: "Light (or darkness)", hint: "You brought it, or drove it away." },
      { q: "Forward I am heavy, backward I am not. What am I?", a: "Ton (not)", hint: "Play with letters, not meaning." },
    ];

    const NPCS = {
      quest: [
        { name: 'Aldric the Weary', role: 'Retired Adventurer', look: 'Gray beard, missing hand', hook: '"I was there when the tomb was sealed. Someone must finish what we started."', info: '"Take silver. Take fire. Don\'t read inscriptions aloud."', reward: '150 gp + map' },
        { name: 'Sister Merewyn', role: 'Temple Healer', look: 'Scarred half-elf', hook: '"The Sunblade was taken. Without it, darkness spreads."', info: '"The cult fears true faith. I can bless your weapons."', reward: 'Blessed weapons + 100 gp' },
        { name: 'Vex', role: 'Info Broker', look: 'Hooded tiefling', hook: '"Someone set up in the ruins. Bad for business. Make them relocate."', info: '"Watch for traps. Previous owners were paranoid."', reward: '200 gp + safe path' },
      ],
      shop: [
        { name: "Durnan's Provisions", keeper: 'Gruff dwarf', items: ['Torch √ó10 (1gp)', 'Rope 50ft (1gp)', 'Holy Water (25gp)', "Healer's Kit (5gp)", 'Crowbar (2gp)'] },
        { name: 'Steel & Shadow', keeper: 'Quiet half-orc', items: ['Silvered Weapon (+100gp)', 'Arrows √ó20 (1gp)', 'Shield (10gp)', 'Manacles (2gp)'] },
      ],
      rumors: [
        '"The dungeon changes. Rooms appear that weren\'t there..."',
        '"A rival party went in last week. Haven\'t been seen since."',
        '"Don\'t trust anything down there. Even the treasure."',
        '"There\'s a back entrance through the old well."',
        '"Something big moved in recently. The small things are scared now."',
      ],
    };

    const ROOMS = [
      { type: 'entrance', name: 'Entrance Hall', icon: 'DoorOpen', shape: 'rect', w: 3, h: 2 },
      { type: 'guard', name: 'Guard Post', icon: 'Shield', shape: 'rect', w: 2, h: 2 },
      { type: 'storage', name: 'Storage', icon: 'Archive', shape: 'rect', w: 2, h: 3 },
      { type: 'shrine', name: 'Shrine', icon: 'Church', shape: 'circle', w: 3, h: 3 },
      { type: 'crypt', name: 'Crypt', icon: 'Skull', shape: 'rect', w: 4, h: 2 },
      { type: 'treasury', name: 'Treasury', icon: 'Coins', shape: 'octagon', w: 2, h: 2 },
      { type: 'library', name: 'Archives', icon: 'Library', shape: 'rect', w: 3, h: 3 },
      { type: 'prison', name: 'Cells', icon: 'Lock', shape: 'rect', w: 2, h: 4 },
      { type: 'lair', name: 'Boss Lair', icon: 'Crown', shape: 'rect', w: 4, h: 4 },
    ];

    const DESCS = {
      entrance: ['Worn steps descend into shadow.', 'Ancient doors hang askew.', 'The threshold between worlds.'],
      guard: ['Signs of a violent last stand.', 'Arrow slits line the walls.', 'Rusted weapons among old bones.'],
      storage: ['Collapsed shelves, rotting crates.', 'Something moved recently.', 'Supplies for a siege that ended badly.'],
      shrine: ['Altar stained with blood.', 'Candles burn without source.', 'Defaced icons stare accusingly.'],
      crypt: ['Stone coffins line the walls.', 'Names scratched from tombs.', 'The dead were not buried with respect.'],
      treasury: ['Empty pedestals hint at stolen glory.', 'A single chest, suspiciously pristine.', 'Gold coins carpet the floor‚Äîwhy?'],
      library: ['Books crumble at touch.', 'Something rustles above.', 'Forbidden texts stained with blood.'],
      prison: ['Chains rattle in empty cells.', 'Scratch marks inside doors.', 'Something is still imprisoned here.'],
      lair: ['This is where it waits.', 'Trophies of victims on walls.', 'The air thrums with malevolence.'],
    };

    // ===================== GENERATOR =====================
    
    const generate = (cfg) => {
      let s = cfg.seed || Date.now();
      const rng = () => { let x = Math.sin(s++) * 10000; return x - Math.floor(x); };
      const pick = (a) => a[Math.floor(rng() * a.length)];

      const roomCount = cfg.sessionType === 'oneshot' ? 8 + Math.floor(rng() * 4) : 14 + Math.floor(rng() * 6);
      const rooms = [];
      const GRID = 60;
      const usedCells = new Set();

      const cellKey = (x, y) => `${x},${y}`;
      const markCells = (x, y, w, h) => { for (let dx = 0; dx < w; dx++) for (let dy = 0; dy < h; dy++) usedCells.add(cellKey(x + dx, y + dy)); };
      const canPlace = (x, y, w, h) => {
        if (x < 0 || y < 0 || x + w > GRID || y + h > GRID) return false;
        for (let dx = 0; dx < w; dx++) for (let dy = 0; dy < h; dy++) if (usedCells.has(cellKey(x + dx, y + dy))) return false;
        return true;
      };

      const entrance = { ...ROOMS[0], id: 0, x: Math.floor(GRID/2) - 1, y: 0, conn: [], desc: pick(DESCS.entrance), enc: null, boss: null, trap: null, treasure: null, feat: null, secret: false, puzzle: null };
      rooms.push(entrance);
      markCells(entrance.x, entrance.y, entrance.w, entrance.h);

      for (let i = 1; i < roomCount; i++) {
        const isLast = i === roomCount - 1;
        const rt = isLast ? ROOMS.find(t => t.type === 'lair') : pick(ROOMS.filter(t => !['entrance', 'lair'].includes(t.type)));
        
        let placed = false, attempts = 0;
        while (!placed && attempts < 200) {
          const parent = rooms[Math.floor(rng() * rooms.length)];
          const dir = pick(['n', 's', 'e', 'w']);
          const gap = 1 + Math.floor(rng() * 2);
          let nx, ny;
          
          switch(dir) {
            case 'n': nx = parent.x; ny = parent.y - rt.h - gap; break;
            case 's': nx = parent.x; ny = parent.y + parent.h + gap; break;
            case 'e': nx = parent.x + parent.w + gap; ny = parent.y; break;
            case 'w': nx = parent.x - rt.w - gap; ny = parent.y; break;
          }

          if (canPlace(nx, ny, rt.w, rt.h)) {
            let enc = null;
            if (!isLast && rng() > 0.35) {
              const possible = Object.values(MONSTERS).filter(m => {
                const cr = m.cr.includes('/') ? (m.cr === '1/8' ? 0.125 : 0.25) : parseFloat(m.cr);
                return cr <= cfg.partyLevel && cr >= cfg.partyLevel * 0.2;
              });
              if (possible.length) {
                const mon = pick(possible);
                enc = { mon, count: Math.max(1, Math.min(6, Math.floor(cfg.partySize * 0.5 + rng() * 2))), tac: pick(['Aggressive', 'Defensive', 'Ambush', 'Flee if bloodied', 'Protect objective']) };
              }
            }

            let boss = null;
            if (isLast) {
              const tmpl = pick(BOSSES);
              boss = { ...MONSTERS[tmpl.base], title: tmpl.title, mod: tmpl.mod, lair: tmpl.lair };
            }

            rooms.push({
              id: i, ...rt, x: nx, y: ny, conn: [parent.id],
              desc: pick(DESCS[rt.type] || ['A chamber of unknown purpose.']),
              enc, boss,
              trap: rng() > 0.72 ? pick(TRAPS) : null,
              treasure: rng() > 0.55 ? pick(TREASURE[isLast ? 'major' : rng() > 0.65 ? 'moderate' : 'minor']) : null,
              feat: rng() > 0.5 ? pick(FEATURES) : null,
              secret: rng() > 0.85,
              puzzle: !isLast && rng() > 0.75 ? (rng() > 0.5 ? pick(PUZZLES) : { riddle: pick(RIDDLES) }) : null,
            });
            markCells(nx, ny, rt.w, rt.h);
            parent.conn.push(i);
            placed = true;
          }
          attempts++;
        }
      }

      const encTable = [];
      for (let i = 1; i <= 6; i++) {
        const possible = Object.values(MONSTERS).filter(m => {
          const cr = m.cr.includes('/') ? (m.cr === '1/8' ? 0.125 : 0.25) : parseFloat(m.cr);
          return cr <= cfg.partyLevel + 1;
        });
        encTable.push({ roll: i, mon: pick(possible), count: 1 + Math.floor(rng() * 2) });
      }

      let town = null;
      if (cfg.includeTown) {
        town = {
          name: pick(['Thornhaven', 'Millbrook', 'Ravenshollow', 'Duskwall', 'Ironford', 'Ashwick']),
          inn: pick(['The Rusty Nail', "The Wanderer's Rest", 'The Broken Crown', 'The Last Lantern']),
          quest: pick(NPCS.quest), shop: pick(NPCS.shop),
          rumors: [pick(NPCS.rumors), pick(NPCS.rumors)].filter((v, i, a) => a.indexOf(v) === i),
        };
      }

      return { rooms, seed: s, encTable, town, cfg, gridSize: GRID };
    };

    // ===================== EXPORT =====================
    
    const exportPDF = (d) => {
      let h = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Dungeon ${d.seed}</title>
<style>body{font-family:system-ui;max-width:850px;margin:0 auto;padding:24px;line-height:1.6;font-size:13px}
h1{text-align:center;border-bottom:3px solid #161616;padding-bottom:12px}h2{background:#161616;color:#fff;padding:8px 16px;margin:24px 0 12px}
.room{border:1px solid #ccc;padding:16px;margin:16px 0;page-break-inside:avoid;background:#fafafa}
.stat{background:#f0f0f0;border:1px solid #aaa;padding:12px;margin:8px 0;font-size:12px}
.trap{background:#f6f0ff;border-left:4px solid #8a3ffc;padding:12px;margin:8px 0}
.enc{background:#fff0f0;border-left:4px solid #da1e28;padding:12px;margin:8px 0}
.boss{background:#1a0505;color:#fff;padding:16px;margin:12px 0}
.treasure{background:#fffbeb;border-left:4px solid #f59e0b;padding:12px;margin:8px 0}
.puzzle{background:#fdf4ff;border-left:4px solid #d946ef;padding:12px;margin:8px 0}
.town{background:#f0fdf4;border:2px solid #22c55e;padding:16px;margin:16px 0}
.desc{font-style:italic;color:#525252;background:#f5f5f5;padding:10px;border-left:4px solid #888;margin:8px 0}
table{width:100%;border-collapse:collapse}th,td{border:1px solid #ccc;padding:8px}
@media print{.page-break{page-break-before:always}}</style></head><body>`;
      h += `<h1>üè∞ Dungeon Session</h1><p style="text-align:center">${d.cfg.sessionType} | Party: ${d.cfg.partySize}√óL${d.cfg.partyLevel} | ${d.rooms.length} rooms | Seed: ${d.seed}</p>`;
      
      if (d.town) {
        h += `<div class="town"><h2>üèòÔ∏è ${d.town.name}</h2><p>üç∫ ${d.town.inn}</p>`;
        h += `<h3>üìú ${d.town.quest.name}</h3><p><em>${d.town.quest.role} ‚Ä¢ ${d.town.quest.look}</em></p>`;
        h += `<p><strong>Hook:</strong> "${d.town.quest.hook}"</p><p><strong>Info:</strong> "${d.town.quest.info}"</p><p><strong>Reward:</strong> ${d.town.quest.reward}</p>`;
        h += `<h3>üõí ${d.town.shop.name}</h3><p>${d.town.shop.items.join(' ‚Ä¢ ')}</p>`;
        h += `<h3>üëÇ Rumors</h3><ul>${d.town.rumors.map(r=>`<li><em>${r}</em></li>`).join('')}</ul></div>`;
      }

      h += `<h2>üé≤ Random Encounters (d6)</h2><table><tr><th>d6</th><th>Encounter</th><th>CR</th></tr>`;
      d.encTable.forEach(e => h += `<tr><td>${e.roll}</td><td>${e.count}√ó ${e.mon.name}</td><td>${e.mon.cr}</td></tr>`);
      h += `</table><h2 class="page-break">üó∫Ô∏è Room Key</h2>`;

      d.rooms.forEach(r => {
        h += `<div class="room"><strong>Room ${r.id + 1}: ${r.name}</strong>${r.secret ? ' üîí' : ''}${r.boss ? ' üíÄ' : ''}<div class="desc">"${r.desc}"</div>`;
        h += `<p><strong>Exits:</strong> ${r.conn.map(c => `Room ${c + 1}`).join(', ')}</p>`;
        if (r.feat) h += `<p><strong>‚öôÔ∏è ${r.feat.name}:</strong> ${r.feat.effect}</p>`;
        if (r.trap) h += `<div class="trap"><strong>‚ö†Ô∏è ${r.trap.name}</strong> ‚Äî ${r.trap.desc}<br/>Trigger: ${r.trap.trigger} | Detect DC ${r.trap.det} | Disarm DC ${r.trap.dis}<br/><strong>Effect:</strong> ${r.trap.eff}</div>`;
        if (r.puzzle) {
          if (r.puzzle.riddle) h += `<div class="puzzle"><strong>‚ùì RIDDLE:</strong> "${r.puzzle.riddle.q}"<br/>Answer: ${r.puzzle.riddle.a} | Hint: ${r.puzzle.riddle.hint}</div>`;
          else h += `<div class="puzzle"><strong>üß© ${r.puzzle.name}</strong><br/>${r.puzzle.setup}<br/><strong>Solution:</strong> ${r.puzzle.solution}<br/><strong>Hint:</strong> ${r.puzzle.hint}<br/><strong>Failure:</strong> ${r.puzzle.trap}</div>`;
        }
        if (r.enc) h += `<div class="enc"><strong>‚öîÔ∏è ${r.enc.count}√ó ${r.enc.mon.name}</strong> (CR ${r.enc.mon.cr}) ‚Äî AC ${r.enc.mon.ac}, HP ${r.enc.mon.hp}<br/>${r.enc.mon.atk.map(a=>`${a.n} +${a.h} (${a.d})`).join('; ')}<br/><em>Tactics: ${r.enc.tac}</em></div>`;
        if (r.boss) h += `<div class="boss"><h4>üíÄ ${r.boss.title}</h4><p>AC ${r.boss.ac} | HP ${r.boss.hp} | CR ${r.boss.cr}</p><p><strong>Mod:</strong> ${r.boss.mod}</p><p><strong>Lair:</strong> ${r.boss.lair}</p></div>`;
        if (r.treasure) h += `<div class="treasure">üí∞ ${r.treasure}</div>`;
        h += `</div>`;
      });

      h += `<h2 class="page-break">üìñ Monster Reference</h2>`;
      const used = new Set(); d.rooms.forEach(r => { if(r.enc)used.add(r.enc.mon.name); if(r.boss)used.add(r.boss.name); }); d.encTable.forEach(e=>used.add(e.mon.name));
      Object.values(MONSTERS).filter(m=>used.has(m.name)).forEach(m => {
        h += `<div class="stat"><strong>${m.name}</strong> (CR ${m.cr}) ‚Äî <em>${m.desc}</em><br/>AC ${m.ac} | HP ${m.hp} | Speed ${m.speed}<br/>STR ${m.str} DEX ${m.dex} CON ${m.con} INT ${m.int} WIS ${m.wis} CHA ${m.cha}<br/>`;
        h += `<strong>Attacks:</strong> ${m.atk.map(a=>`${a.n} +${a.h}${a.r?' ('+a.r+')':''}: ${a.d}${a.s?' ‚Äî '+a.s:''}`).join('; ')}<br/>`;
        if(m.traits.length) h += `<strong>Traits:</strong> ${m.traits.join(' ‚Ä¢ ')}`;
        h += `</div>`;
      });
      h += `</body></html>`;
      
      const blob = new Blob([h], { type: 'text/html' });
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `dungeon-${d.seed}.html`; a.click();
    };

    // ===================== COMPONENTS =====================
    
    const StatBlock = ({ monster, count = 1 }) => (
      <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-3 text-sm">
        <div className="flex justify-between items-start mb-2">
          <div><h4 className="font-semibold text-zinc-100">{count > 1 && `${count}√ó `}{monster.name}</h4><p className="text-xs text-zinc-400 italic">{monster.desc}</p></div>
          <span className="bg-zinc-600 px-2 py-0.5 rounded text-xs">CR {monster.cr}</span>
        </div>
        <div className="grid grid-cols-6 gap-1 bg-zinc-900 rounded p-2 my-2 text-xs text-center">
          {['STR','DEX','CON','INT','WIS','CHA'].map((s,i) => <div key={s}><div className="text-zinc-500">{s}</div><div className="text-zinc-100">{[monster.str,monster.dex,monster.con,monster.int,monster.wis,monster.cha][i]}</div></div>)}
        </div>
        <div className="text-xs text-zinc-300 space-y-1">
          <p><Icon name="Shield" size={12}/> AC {monster.ac} <Icon name="Heart" size={12}/> HP {monster.hp}{count>1?' each':''} <Icon name="Footprints" size={12}/> {monster.speed}</p>
          {monster.atk.map((a,i) => <p key={i}><Icon name="Sword" size={12}/> <strong>{a.n}:</strong> +{a.h}{a.r?` (${a.r})`:''}, {a.d}{a.s && <span className="text-red-400"> ({a.s})</span>}</p>)}
          {monster.traits.length > 0 && <p className="text-zinc-400"><Icon name="Zap" size={12}/> {monster.traits.join(' ‚Ä¢ ')}</p>}
        </div>
      </div>
    );

    const DungeonMap = ({ dungeon, revealed, selected, onSelect, showAll }) => {
      const scale = 8, padding = 20;
      let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
      dungeon.rooms.forEach(r => { minX = Math.min(minX, r.x); minY = Math.min(minY, r.y); maxX = Math.max(maxX, r.x + r.w); maxY = Math.max(maxY, r.y + r.h); });
      const width = (maxX - minX) * scale + padding * 2, height = (maxY - minY) * scale + padding * 2;
      const offsetX = -minX * scale + padding, offsetY = -minY * scale + padding;

      return (
        <svg width={width} height={height} className="mx-auto block bg-zinc-900 rounded-lg">
          <defs><pattern id="grid" width={scale} height={scale} patternUnits="userSpaceOnUse"><path d={`M ${scale} 0 L 0 0 0 ${scale}`} fill="none" stroke="#27272a" strokeWidth="0.5"/></pattern></defs>
          <rect width={width} height={height} fill="#18181b"/><rect width={width} height={height} fill="url(#grid)"/>
          {dungeon.rooms.map(r => r.conn.map(tid => {
            if (tid > r.id) return null;
            const t = dungeon.rooms.find(rm => rm.id === tid);
            if (!t) return null;
            const vis = (revealed.has(r.id) && revealed.has(t.id)) || showAll;
            if (!vis) return null;
            const rx = r.x * scale + offsetX + (r.w * scale) / 2, ry = r.y * scale + offsetY + (r.h * scale) / 2;
            const tx = t.x * scale + offsetX + (t.w * scale) / 2, ty = t.y * scale + offsetY + (t.h * scale) / 2;
            return <g key={`${r.id}-${tid}`}><line x1={rx} y1={ry} x2={tx} y2={ty} stroke="#52525b" strokeWidth={6} strokeLinecap="round"/><rect x={(rx+tx)/2-3} y={(ry+ty)/2-3} width={6} height={6} fill="#71717a" stroke="#a1a1aa"/></g>;
          }))}
          {dungeon.rooms.map(r => {
            const vis = revealed.has(r.id) || showAll, sel = selected?.id === r.id, isBoss = r.boss != null;
            const x = r.x * scale + offsetX, y = r.y * scale + offsetY, w = r.w * scale, h = r.h * scale;
            const fill = vis ? (isBoss ? '#450a0a' : '#3f3f46') : '#1f1f23';
            const stroke = sel ? '#60a5fa' : vis ? (isBoss ? '#dc2626' : '#71717a') : '#27272a';
            let shape = <rect x={x} y={y} width={w} height={h} rx={2} fill={fill} stroke={stroke} strokeWidth={sel ? 2 : 1}/>;
            if (r.shape === 'circle') shape = <circle cx={x + w/2} cy={y + h/2} r={Math.min(w, h) / 2} fill={fill} stroke={stroke} strokeWidth={sel ? 2 : 1}/>;
            else if (r.shape === 'octagon') {
              const ins = Math.min(w, h) * 0.25;
              const pts = [[x+ins,y],[x+w-ins,y],[x+w,y+ins],[x+w,y+h-ins],[x+w-ins,y+h],[x+ins,y+h],[x,y+h-ins],[x,y+ins]].map(p=>p.join(',')).join(' ');
              shape = <polygon points={pts} fill={fill} stroke={stroke} strokeWidth={sel ? 2 : 1}/>;
            }
            return (
              <g key={r.id} onClick={() => onSelect(r)} style={{ cursor: 'pointer' }}>
                {shape}
                {vis ? <><text x={x+w/2} y={y+h/2+3} textAnchor="middle" fontSize={10} fill={isBoss ? '#fca5a5' : '#d4d4d8'}>{r.id+1}</text>
                  {r.trap && <circle cx={x+w-4} cy={y+4} r={3} fill="#a855f7"/>}{r.secret && <circle cx={x+4} cy={y+4} r={3} fill="#22c55e"/>}{r.puzzle && <circle cx={x+w/2} cy={y+4} r={3} fill="#ec4899"/>}</>
                  : <text x={x+w/2} y={y+h/2+3} textAnchor="middle" fontSize={10} fill="#52525b">?</text>}
              </g>
            );
          })}
        </svg>
      );
    };

    // ===================== MAIN APP =====================
    
    function App() {
      const [step, setStep] = useState('config');
      const [cfg, setCfg] = useState({ sessionType: 'oneshot', partySize: 4, partyLevel: 3, includeTown: true });
      const [dun, setDun] = useState(null);
      const [sel, setSel] = useState(null);
      const [rev, setRev] = useState(new Set([0]));
      const [view, setView] = useState('town');
      const [showAll, setShowAll] = useState(false);

      const gen = useCallback(() => { const d = generate(cfg); setDun(d); setSel(null); setRev(new Set([0])); setShowAll(false); setStep('dun'); setView(cfg.includeTown ? 'town' : 'map'); }, [cfg]);
      const clickRoom = (r) => { setSel(r); if (!showAll) setRev(p => new Set([...p, r.id, ...r.conn])); };
      const toggleReveal = () => { if (showAll) { setShowAll(false); setRev(new Set([0])); } else { setShowAll(true); setRev(new Set(dun.rooms.map(r => r.id))); } };

      if (step === 'config') return (
        <div className="min-h-screen bg-zinc-900 text-zinc-100 p-4">
          <div className="max-w-lg mx-auto">
            <div className="text-center mb-6">
              <div className="flex items-center justify-center gap-2 mb-2"><Icon name="Map" size={32} color="#60a5fa"/><h1 className="text-2xl font-bold">Abyssal Cartographer</h1></div>
              <p className="text-zinc-400 text-sm">Complete D&D Session Generator v1.1</p>
            </div>
            <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-4 space-y-5">
              <div>
                <label className="flex items-center gap-2 text-sm font-medium text-zinc-300 mb-2"><Icon name="Settings" size={14}/>Session Type</label>
                <div className="grid grid-cols-2 gap-2">
                  {[{id:'oneshot',name:'One-Shot',d:'8-12 rooms',ic:'Zap'},{id:'campaign',name:'Campaign',d:'14-20 rooms',ic:'BookOpen'}].map(t=>(
                    <button key={t.id} onClick={()=>setCfg(c=>({...c,sessionType:t.id}))} className={`p-3 rounded-lg border-2 text-left transition ${cfg.sessionType===t.id?'bg-blue-900/30 border-blue-500':'bg-zinc-800 border-zinc-700 hover:border-zinc-500'}`}>
                      <div className="flex items-center gap-2 mb-0.5"><Icon name={t.ic} size={16} color={cfg.sessionType===t.id?'#60a5fa':'#71717a'}/><span className="font-medium">{t.name}</span></div>
                      <span className="text-xs text-zinc-400">{t.d}</span>
                    </button>
                  ))}
                </div>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <div><label className="flex items-center gap-2 text-sm font-medium text-zinc-300 mb-1"><Icon name="Users" size={14}/>Party Size</label>
                  <select value={cfg.partySize} onChange={e=>setCfg(c=>({...c,partySize:+e.target.value}))} className="w-full bg-zinc-900 border border-zinc-600 rounded-lg p-2 text-zinc-100">{[2,3,4,5,6].map(n=><option key={n} value={n}>{n} players</option>)}</select></div>
                <div><label className="flex items-center gap-2 text-sm font-medium text-zinc-300 mb-1"><Icon name="Sword" size={14}/>Level</label>
                  <select value={cfg.partyLevel} onChange={e=>setCfg(c=>({...c,partyLevel:+e.target.value}))} className="w-full bg-zinc-900 border border-zinc-600 rounded-lg p-2 text-zinc-100">{[1,2,3,4,5,6,7,8,9,10].map(n=><option key={n} value={n}>Level {n}</option>)}</select></div>
              </div>
              <div>
                <label className="flex items-center gap-2 text-sm font-medium text-zinc-300 mb-2"><Icon name="Home" size={14}/>Start Location</label>
                <div className="grid grid-cols-2 gap-2">
                  <button onClick={()=>setCfg(c=>({...c,includeTown:true}))} className={`p-3 rounded-lg border-2 text-left ${cfg.includeTown?'bg-green-900/30 border-green-500':'bg-zinc-800 border-zinc-700'}`}>
                    <div className="flex items-center gap-2"><Icon name="Home" size={16} color={cfg.includeTown?'#4ade80':'#71717a'}/><span className="font-medium">Town</span></div>
                    <span className="text-xs text-zinc-400">Quest, shop, rumors</span>
                  </button>
                  <button onClick={()=>setCfg(c=>({...c,includeTown:false}))} className={`p-3 rounded-lg border-2 text-left ${!cfg.includeTown?'bg-red-900/30 border-red-500':'bg-zinc-800 border-zinc-700'}`}>
                    <div className="flex items-center gap-2"><Icon name="DoorOpen" size={16} color={!cfg.includeTown?'#f87171':'#71717a'}/><span className="font-medium">Dungeon</span></div>
                    <span className="text-xs text-zinc-400">Straight to action</span>
                  </button>
                </div>
              </div>
              <button onClick={gen} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-3 rounded-lg flex items-center justify-center gap-2"><Icon name="Dices" size={20}/>Generate Session</button>
            </div>
            <p className="text-center text-zinc-500 text-xs mt-4">Abyssal Cartographer v1.1 ‚Ä¢ Now with puzzles! üéÅ</p>
          </div>
        </div>
      );

      if (!dun) return null;

      return (
        <div className="min-h-screen bg-zinc-900 text-zinc-100">
          <header className="bg-zinc-800 border-b border-zinc-700 px-3 py-2">
            <div className="flex items-center gap-2 flex-wrap">
              <Icon name="Map" size={18} color="#60a5fa"/><span className="font-semibold text-sm mr-2 hidden sm:inline">Abyssal Cartographer</span>
              <nav className="flex gap-1">
                {dun.town && <button onClick={()=>setView('town')} className={`px-2 py-1 text-xs rounded flex items-center gap-1 ${view==='town'?'bg-blue-600 text-white':'text-zinc-400 hover:bg-zinc-700'}`}><Icon name="Home" size={12}/>Town</button>}
                <button onClick={()=>setView('map')} className={`px-2 py-1 text-xs rounded flex items-center gap-1 ${view==='map'?'bg-blue-600 text-white':'text-zinc-400 hover:bg-zinc-700'}`}><Icon name="Map" size={12}/>Map</button>
                <button onClick={()=>setView('enc')} className={`px-2 py-1 text-xs rounded flex items-center gap-1 ${view==='enc'?'bg-blue-600 text-white':'text-zinc-400 hover:bg-zinc-700'}`}><Icon name="Sword" size={12}/>Enc</button>
                <button onClick={()=>setView('ref')} className={`px-2 py-1 text-xs rounded flex items-center gap-1 ${view==='ref'?'bg-blue-600 text-white':'text-zinc-400 hover:bg-zinc-700'}`}><Icon name="BookOpen" size={12}/>Ref</button>
              </nav>
              <div className="flex-1"/>
              <button onClick={()=>exportPDF(dun)} className="p-1.5 text-zinc-400 hover:bg-zinc-700 rounded" title="Export"><Icon name="Download" size={16}/></button>
              <button onClick={()=>setStep('config')} className="p-1.5 text-zinc-400 hover:bg-zinc-700 rounded" title="New"><Icon name="RotateCcw" size={16}/></button>
            </div>
          </header>

          <main className="p-3">
            {view === 'town' && dun.town && (
              <div className="max-w-xl mx-auto space-y-3">
                <div className="bg-green-950/50 border border-green-700 rounded-lg p-4">
                  <div className="flex items-center gap-3 mb-3"><Icon name="Home" size={24} color="#4ade80"/><div><h2 className="text-lg font-bold text-green-400">{dun.town.name}</h2><p className="text-xs text-zinc-400">üç∫ {dun.town.inn}</p></div></div>
                  <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-3 mb-3">
                    <div className="flex items-start gap-2"><Icon name="ScrollText" size={20} color="#facc15" className="mt-0.5 flex-shrink-0"/><div>
                      <h3 className="font-semibold text-yellow-400">{dun.town.quest.name}</h3>
                      <p className="text-xs text-zinc-400">{dun.town.quest.role} ‚Ä¢ {dun.town.quest.look}</p>
                      <div className="bg-zinc-900 rounded p-2 my-2 border-l-2 border-yellow-500"><p className="text-sm italic">"{dun.town.quest.hook}"</p></div>
                      <p className="text-xs text-zinc-300"><strong>Info:</strong> "{dun.town.quest.info}"</p>
                      <p className="text-xs text-green-400 mt-1"><strong>Reward:</strong> {dun.town.quest.reward}</p>
                    </div></div>
                  </div>
                  <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-3 mb-3">
                    <div className="flex items-start gap-2"><Icon name="Coins" size={20} color="#facc15" className="flex-shrink-0"/><div>
                      <h3 className="font-semibold">{dun.town.shop.name}</h3>
                      <p className="text-xs text-zinc-400 mb-1">{dun.town.shop.keeper}</p>
                      <div className="flex flex-wrap gap-1">{dun.town.shop.items.map((item,i)=><span key={i} className="text-xs bg-zinc-700 px-2 py-0.5 rounded">{item}</span>)}</div>
                    </div></div>
                  </div>
                  <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-3">
                    <h3 className="font-semibold text-purple-400 mb-2 flex items-center gap-2"><Icon name="MessageSquare" size={16}/>Rumors</h3>
                    {dun.town.rumors.map((r,i)=><p key={i} className="text-sm text-zinc-300 italic mb-1">‚Ä¢ {r}</p>)}
                  </div>
                </div>
                <button onClick={()=>setView('map')} className="w-full bg-blue-600 hover:bg-blue-700 text-white font-medium py-2.5 rounded-lg flex items-center justify-center gap-2"><Icon name="ChevronRight" size={18}/>Enter Dungeon</button>
              </div>
            )}

            {view === 'map' && (
              <div className="flex flex-col lg:flex-row gap-3">
                <div className="flex-1">
                  <div className="flex justify-between items-center mb-2">
                    <div className="flex gap-2"><span className="bg-zinc-700 px-2 py-0.5 rounded text-xs">{dun.rooms.length} rooms</span><span className="bg-zinc-700 px-2 py-0.5 rounded text-xs">Seed: {dun.seed}</span></div>
                    <button onClick={toggleReveal} className="px-2 py-1 text-xs text-zinc-400 hover:bg-zinc-700 rounded flex items-center gap-1">{showAll?<><Icon name="EyeOff" size={12}/>Hide</>:<><Icon name="Eye" size={12}/>Reveal</>}</button>
                  </div>
                  <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-2 overflow-auto">
                    <DungeonMap dungeon={dun} revealed={rev} selected={sel} onSelect={clickRoom} showAll={showAll}/>
                  </div>
                  <div className="flex gap-4 justify-center mt-2 text-xs text-zinc-500">
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-purple-500"/>Trap</span>
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-green-500"/>Secret</span>
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-pink-500"/>Puzzle</span>
                    <span className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-red-500"/>Boss</span>
                  </div>
                </div>
                <div className="lg:w-96">
                  {sel ? (
                    <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-3 space-y-2 max-h-[80vh] overflow-auto">
                      <div className="flex items-start justify-between">
                        <div className="flex items-center gap-2"><div className="w-9 h-9 rounded bg-zinc-700 flex items-center justify-center"><Icon name={sel.icon} size={20} color={sel.boss?'#f87171':'#d4d4d8'}/></div><div><h3 className="font-semibold">{sel.name}</h3><span className="text-xs text-zinc-400">Room {sel.id+1}</span></div></div>
                        <div className="flex gap-1 flex-wrap justify-end">{sel.secret && <span className="bg-green-600 px-2 py-0.5 rounded text-xs">Secret</span>}{sel.boss && <span className="bg-red-600 px-2 py-0.5 rounded text-xs">Boss</span>}</div>
                      </div>
                      <div className="bg-zinc-900 rounded p-2 border-l-2 border-zinc-600"><p className="text-sm italic text-zinc-300">"{sel.desc}"</p></div>
                      <p className="text-xs text-zinc-400"><Icon name="Footprints" size={12}/> Exits: {sel.conn.map(c=>`Room ${c+1}`).join(', ')}</p>
                      {sel.feat && <div className="bg-blue-900/30 rounded p-2 border-l-2 border-blue-500"><p className="text-xs text-blue-300"><Icon name="Info" size={12}/> <strong>{sel.feat.name}:</strong> {sel.feat.effect}</p></div>}
                      {sel.trap && <div className="bg-purple-900/30 rounded p-2 border-l-2 border-purple-500"><h4 className="text-xs font-semibold text-purple-300 flex items-center gap-1 mb-1"><Icon name="AlertTriangle" size={12}/>TRAP: {sel.trap.name}</h4><p className="text-xs text-zinc-400 italic mb-1">{sel.trap.desc}</p><p className="text-xs">Trigger: {sel.trap.trigger}<br/>Detect DC {sel.trap.det} | Disarm DC {sel.trap.dis}<br/><span className="text-red-300">Effect: {sel.trap.eff}</span></p></div>}
                      {sel.puzzle && (
                        <div className="bg-pink-900/30 rounded p-2 border-l-2 border-pink-500">
                          {sel.puzzle.riddle ? (<><h4 className="text-xs font-semibold text-pink-300 flex items-center gap-1 mb-1"><Icon name="HelpCircle" size={12}/>RIDDLE</h4><p className="text-sm italic text-zinc-200 mb-1">"{sel.puzzle.riddle.q}"</p><p className="text-xs text-zinc-400">Answer: <span className="text-pink-300">{sel.puzzle.riddle.a}</span></p><p className="text-xs text-zinc-500">Hint: {sel.puzzle.riddle.hint}</p></>) : (<><h4 className="text-xs font-semibold text-pink-300 flex items-center gap-1 mb-1"><Icon name="Puzzle" size={12}/>PUZZLE: {sel.puzzle.name}</h4><p className="text-xs mb-1"><strong>Setup:</strong> {sel.puzzle.setup}</p><p className="text-xs mb-1"><strong>Solution:</strong> <span className="text-pink-300">{sel.puzzle.solution}</span></p><p className="text-xs text-zinc-500">Hint: {sel.puzzle.hint}</p><p className="text-xs text-red-300">Failure: {sel.puzzle.trap}</p></>)}
                        </div>
                      )}
                      {sel.enc && <div><h4 className="text-xs font-semibold text-red-400 flex items-center gap-1 mb-1"><Icon name="Sword" size={12}/>ENCOUNTER</h4><StatBlock monster={sel.enc.mon} count={sel.enc.count}/><p className="text-xs text-zinc-400 mt-1 italic">Tactics: {sel.enc.tac}</p></div>}
                      {sel.boss && <div className="bg-red-950/50 rounded p-3 border border-red-800"><h4 className="text-base font-bold text-red-400 flex items-center gap-2 mb-2"><Icon name="Skull" size={18}/>{sel.boss.title}</h4><p className="text-xs text-zinc-300 italic mb-2">{sel.boss.desc}</p><div className="grid grid-cols-3 gap-1 text-center bg-red-950 rounded p-1.5 mb-2 text-xs"><div><span className="text-red-400">AC</span><br/>{sel.boss.ac}</div><div><span className="text-red-400">HP</span><br/>{sel.boss.hp}</div><div><span className="text-red-400">CR</span><br/>{sel.boss.cr}</div></div><p className="text-xs mb-1"><strong className="text-yellow-400">Mod:</strong> {sel.boss.mod}</p><p className="text-xs"><strong className="text-blue-400">Lair:</strong> {sel.boss.lair}</p></div>}
                      {sel.treasure && <div className="bg-yellow-900/30 rounded p-2 border-l-2 border-yellow-500 flex items-center gap-2"><Icon name="Gem" size={16} color="#facc15"/><span className="font-medium text-yellow-400">{sel.treasure}</span></div>}
                    </div>
                  ) : <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-4 text-center py-8"><Icon name="Map" size={40} color="#52525b" className="mx-auto mb-3"/><p className="text-zinc-400">Click a room to view details</p></div>}
                </div>
              </div>
            )}

            {view === 'enc' && (
              <div className="max-w-xl mx-auto space-y-3">
                <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-4">
                  <h3 className="font-semibold flex items-center gap-2 mb-2"><Icon name="Dices" size={18} color="#facc15"/>Random Encounters (d6)</h3>
                  <p className="text-xs text-zinc-400 mb-2">Roll every 30 min or when loud.</p>
                  <table className="w-full text-sm"><thead><tr className="border-b border-zinc-700"><th className="text-left py-1 w-10 text-zinc-400">d6</th><th className="text-left py-1 text-zinc-400">Encounter</th><th className="text-left py-1 w-12 text-zinc-400">CR</th></tr></thead>
                    <tbody>{dun.encTable.map(e=><tr key={e.roll} className="border-b border-zinc-800"><td className="py-1 font-mono text-yellow-400">{e.roll}</td><td className="py-1">{e.count}√ó {e.mon.name}</td><td className="py-1 text-zinc-400">{e.mon.cr}</td></tr>)}</tbody>
                  </table>
                </div>
                <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-4">
                  <h3 className="font-semibold flex items-center gap-2 mb-2"><Icon name="Flame" size={18} color="#f87171"/>Room Encounters</h3>
                  {dun.rooms.filter(r=>r.enc||r.boss).map(r=><div key={r.id} className="flex items-center justify-between py-1.5 border-b border-zinc-800">
                    <span className="flex items-center gap-2"><Icon name={r.icon} size={14} color={r.boss?'#f87171':'#71717a'}/>Room {r.id+1}</span>
                    <span className="text-sm text-zinc-400">{r.boss?`üíÄ ${r.boss.title}`:`${r.enc.count}√ó ${r.enc.mon.name}`}</span>
                  </div>)}
                </div>
                <div className="bg-zinc-800 border border-zinc-700 rounded-lg p-4">
                  <h3 className="font-semibold flex items-center gap-2 mb-2"><Icon name="Puzzle" size={18} color="#ec4899"/>Puzzles & Riddles</h3>
                  {dun.rooms.filter(r=>r.puzzle).length===0?<p className="text-sm text-zinc-400 italic">No puzzles in this dungeon.</p>:
                    dun.rooms.filter(r=>r.puzzle).map(r=><div key={r.id} className="py-2 border-b border-zinc-800"><span className="text-sm">Room {r.id+1}: </span><span className="text-pink-400">{r.puzzle.riddle?'Riddle':r.puzzle.name}</span></div>)}
                </div>
              </div>
            )}

            {view === 'ref' && (
              <div className="max-w-xl mx-auto space-y-3">
                <h2 className="font-semibold flex items-center gap-2"><Icon name="BookOpen" size={20} color="#60a5fa"/>Monster Reference</h2>
                {[...new Set([...dun.encTable.map(e=>e.mon.name),...dun.rooms.filter(r=>r.enc).map(r=>r.enc.mon.name),...dun.rooms.filter(r=>r.boss).map(r=>r.boss.name)])].map(name=>{const m=Object.values(MONSTERS).find(x=>x.name===name);return m?<StatBlock key={name} monster={m}/>:null;})}
              </div>
            )}
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>